-- title:   V2 of my Ray Caster
-- author:  joejoemars1
-- desc:    It uses :sparkles: map flags :sparkles:
-- site:    joejoemars1.github.io
-- license: CC BY-SA 4.0
-- version: 0.3.2
-- script:  lua

--[[

 HEY! This file is NOT finished! It'll receive changes and
 updates in the future! Hopefully!
 
 Plans:
 	Global Movement (move map around, won't break code)
	
	Added:
	 Drawing into shadows
		This little changelog
		
	Changed:
	 Remove '0.5' from x and y offsets
	
]]

function BOOT()
	
	--[[ Set vbank 1 transparency to be color 15 ]]--
	vbank(1)
	poke(0x3FF8,15)
	vbank(0)
	
end

--[[ har squidward, mous ]]--
mxlast, mylast = mouse()

function TIC()
	
	cls()
	
	--[[ Stuff for this demo ]]--
	local mx, my, ml = mouse()
	
	if ml then
		
		mxlast, mylast = mx, my
		
	end
	
	mx, my = mxlast, mylast;
	
	--[[ Can't make the demo without the darn function ]]--
	caster(mx, my, 0.15, 20, shadowsLayer)
	
	--[[ Layer 0 drawing :smiley_cat: ]]--
	map()
	
	spr(257, 80, 20 + time()/10 % 50, 15)
	
end

--[[ It's our function to draw in the shadows! ]]
function shadowsLayer()
	spr(257, 80, 20 + time()/10 % 50, 15)
end

function caster(x, y, quality, radius, shadowFunction)
	
	--[[ Clear layer 1 ]]--
	vbank(1)
	
	cls(0)
	
	--[[ Call the function that'll draw into the shadows on
	     vbank 1 if it's a function ]]
	if type(shadowFunction) == "function" then
	
		shadowFunction()
		
	end
	
	--[[ Loop for each degree, increment defined by
	     quality ]]--
	for i=0, 360, quality do
		
		--[[ Need to get the point outside the circle that is
		     being casted to ]]--
		local xRotated, yRotated = x+40*math.sin(math.rad(i))+0.5,y+40*math.cos(math.rad(i))+0.5
		
		--[[ Get the increment to traverse the line by one ]]--
		local xOffset, yOffset = (x-xRotated)/radius, (y-yRotated)/radius
		
		--[[ Var used to trace the path of our line ]]--
		local xTracer, yTracer = x, y
		
		--[[ Loop for the length of the radius ]]--
		for a=1, radius do
			
			--[[ Advance the tracer by one ]]--
			xTracer, yTracer = xTracer + xOffset, yTracer + yOffset
			
			--[[ If the tile the tracer is under has flag 0
			     set, break out of the loop ]]
			if fget(mget(xTracer//8,yTracer//8),0) then
				
				--[[ Enable to make edges of walls not visible ]]--
				--xTracer, yTracer = xTracer - xOffset, yTracer - yOffset
				
				break
				
			end
			
		end
		
		--[[ Draw our line, which'll be transparent because
		     of the poke we did in BOOT ]]
		line(x, y, xTracer, yTracer, 15)
		
	end
	
	--[[ Teh end tem proud ]]
	vbank(0)
	
end
-- <TILES>
-- 001:3333333333333333333333333333333333333333333333333333333333333333
-- 002:5555555555555555555555555555555555555555555555555555555555555555
-- 003:bbaaaaaabbaaaaaaaabbaaaaaabbaaaaaaaabbaaaaaabbaaaaaaaabbaaaaaabb
-- 004:2222111122221111222211112222111111112222111122221111222211112222
-- 005:6699669966996699996699669966996666996699669966999966996699669966
-- 017:2222222222222222222222222222222222222222222222222222222222222222
-- 236:0ccccccccc666666c5555555c5666666c5ccccccc5cc0cccc5cc0cccc5cc0ccc
-- 237:ccccc0006666cc0055550c0066650c00ccc50ccc0cc50c0c0cc50c0c0cc50c0c
-- 238:0ccccccccc666666c5555555c5666666c5ccccccc5ccccccc5cc0cccc5cc0ccc
-- 239:ccccc0006666cc0055550c0066650c00ccc50cccccc50c0c0cc50c0c0cc50c0c
-- 252:c5ccccccc5555555c555c555c5555cccc5555555c6666666cc000ccc0ccccc0c
-- 253:ccc500cc55550cc0c5550c0055550c0055550c006666cc00000cc000cccc0000
-- 254:c5ccccccc5555555c555c555c5555cccc5555555c6666666cc000ccc0ccccc0c
-- 255:ccc500cc55550cc0c5550c0055550c0055550c006666cc00000cc000cccc0000
-- </TILES>

-- <SPRITES>
-- 001:fff77fffff7777ff7777777777777777f777777ff777777f777ff77777ffff77
-- </SPRITES>

-- <MAP>
-- 000:101010101010101010101010101010101010101010101010101010101010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
-- 001:104040404040105050502020202020202020202030303030303030303010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
-- 002:104040404040505050502020202020202020201130113011303030303010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
-- 003:104040404040505050502020202020202020202030303030303030303010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
-- 004:104040404040105050502020202020202020201130113011301130303010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
-- 005:104040404040102050502020202020202020202030303030303030303010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
-- 006:104040404040102050502020202020202020201130113011301130113010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
-- 007:104040404040102050502020202020202020202030303030303030303010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
-- 008:104040404040102050502020202020202020201130113011301130113010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
-- 009:101050501010102050502020202020202020202030303030303030303010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
-- 010:102050502020202050502020202020202020201120112011201120112010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
-- 011:102050505050505050502020202020202020202020202020202020202010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
-- 012:102050505050505050502020202020202020202020202020202020202010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
-- 013:102020202020202020202020202020202020202020202020202020202010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
-- 014:102020202020202020202020202020202020202020202020202020202010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
-- 015:102020202020202020202020202020202020202020202020202020202010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
-- 016:101010101010101010101010101010101010101010101010101010101010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
-- </MAP>

-- <WAVES>
-- 000:00000000ffffffff00000000ffffffff
-- 001:0123456789abcdeffedcba9876543210
-- 002:0123456789abcdef0123456789abcdef
-- </WAVES>

-- <SFX>
-- 000:000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000304000000000
-- </SFX>

-- <TRACKS>
-- 000:100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
-- </TRACKS>

-- <FLAGS>
-- 000:00100000000000000000000000000000001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
-- </FLAGS>

-- <PALETTE>
-- 000:1a1c2ca0c4a6bddbc291b897f6acb6f9bfc7f39da89f77b0ab85bb9068a2eaebefebe1cdefeeebbcb7afedeaedbfaca0
-- 001:1a1c2c5d275db13e53ef7d57ffcd75a7f07038b76425717929366f3b5dc941a6f673eff7f4f4f494b0c2566c86333c57
-- </PALETTE>

